---

name: Nightly Release

# Note: Version override is not allowed in nightly builds.
# For custom version releases, use release.yaml workflow_dispatch instead.

env:
  NIGHTLY_TAG: nightly

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  cleanup:
    runs-on: ubuntu-24.04-arm
    steps:
    - name: Delete existing nightly release and tag
      continue-on-error: true
      run: gh release delete ${{ env.NIGHTLY_TAG }} --yes --repo ${{ github.repository }}
      env:
        GITHUB_TOKEN: ${{ github.token }}

    - name: Delete nightly tag
      continue-on-error: true
      run: git push --delete origin ${{ env.NIGHTLY_TAG }} || true
      env:
        GITHUB_TOKEN: ${{ github.token }}

  build:
    needs: cleanup
    uses: ./.github/workflows/_build-image.yaml
    with:
      version_strategy: 'nightly'
      create_release: true
      fetch_depth: 0
      github_release_tag: ${{ env.NIGHTLY_TAG }}
      release_notes_suffix: '⚠️ This is an automated nightly build. Use at your own risk.'
