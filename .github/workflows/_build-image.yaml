---

name: Build Image (Reusable)
on:
  workflow_call:
    inputs:
      version_strategy:
        description: 'Version strategy: nightly or release'
        required: true
        type: string
      create_release:
        description: 'Create GitHub release'
        required: false
        type: boolean
        default: false
      fetch_depth:
        description: 'Git fetch depth'
        required: false
        type: number
        default: 1
      image_version_override:
        description: 'Override DIST_VERSION and image tag (e.g., "1.0.0-2026-01-17-nightly")'
        required: false
        type: string
        default: ''
      github_release_tag:
        description: 'GitHub release tag (can differ from image version, e.g., "nightly")'
        required: false
        type: string
        default: ''
      release_notes_suffix:
        description: 'Additional text to append to release notes'
        required: false
        type: string
        default: ''
    outputs:
      tag:
        description: 'Image tag'
        value: ${{ jobs.build.outputs.tag }}
      image:
        description: 'Image name'
        value: ${{ jobs.build.outputs.image }}
      fdm_monster_version:
        description: 'FDM Monster version'
        value: ${{ jobs.build.outputs.fdm_monster_version }}
      build_date:
        description: 'Build date'
        value: ${{ jobs.build.outputs.build_date }}

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    outputs:
      tag: ${{ steps.copy.outputs.tag }}
      image: ${{ steps.copy.outputs.image }}
      fdm_monster_version: ${{ steps.copy.outputs.fdm_monster_version }}
      build_date: ${{ steps.copy.outputs.build_date }}
    steps:
    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install coreutils p7zip-full qemu-user-static python3-git

    - name: Checkout CustomPiOS
      uses: actions/checkout@v6.0.1
      with:
        repository: 'guysoft/CustomPiOS'
        path: CustomPiOS
        ref: "79b77a4c1a34ef551ab09e9bd84710d048b65e55"

    - name: Checkout Project Repository
      uses: actions/checkout@v6.0.1
      with:
        path: repository
        submodules: true
        fetch-depth: ${{ inputs.fetch_depth }}

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v4.2.0
      with:
        versionSpec: '6.x'

    - name: Use GitVersion
      uses: gittools/actions/gitversion/execute@v4.2.0
      id: gitversion
      with:
        targetPath: repository

    - name: Download RaspberryPiOS Image
      run: |
        cd repository/src/image-raspberrypiarm64
        wget -c --trust-server-names 'https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2025-12-04/2025-12-04-raspios-trixie-arm64-lite.img.xz'

    - name: Update CustomPiOS Paths
      run: |
        cd repository/src
        ../../CustomPiOS/src/update-custompios-paths

    - name: Set image version
      run: |
        if [ -n "${{ inputs.image_version_override }}" ]; then
          # Use override directly
          echo "DIST_VERSION=${{ inputs.image_version_override }}" > repository/src/config.local
        elif [ "${{ inputs.version_strategy }}" == "release" ]; then
          # Release: use GitVersion only
          echo "DIST_VERSION=${{ steps.gitversion.outputs.majorMinorPatch }}" > repository/src/config.local
        else
          # Build/nightly: use GitVersion with date and strategy suffix
          NOW=$(date +"%Y-%m-%d")
          echo "DIST_VERSION=${{ steps.gitversion.outputs.majorMinorPatch }}-$NOW-${{ inputs.version_strategy }}" > repository/src/config.local
        fi

    - name: Build Image
      run: |
        sudo modprobe loop
        cd repository/src
        sudo bash -x ./build_dist

    - name: Copy output
      id: copy
      run: |
        source repository/src/config
        source repository/src/modules/monsterpi/config

        # TAG is always equal to DIST_VERSION (set in previous step)
        TAG=${DIST_VERSION}
        IMAGE=monsterpi-$TAG

        cp repository/src/workspace/*.img $IMAGE.img

        # Copy build log
        if [ -f repository/src/build.log ]; then
          cp repository/src/build.log $IMAGE-build.log
        fi

        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "image=$IMAGE" >> $GITHUB_OUTPUT
        echo "fdm_monster_version=$MONSTERPI_FDMMONSTER_VERSION" >> $GITHUB_OUTPUT
        echo "build_date=$(date +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_OUTPUT

    - name: Show size and tag
      run: |
        echo "Tag ${{steps.copy.outputs.tag}}"
        echo "File size of ${{ steps.copy.outputs.image }}.img"
        stat --printf="%s" ${{ steps.copy.outputs.image }}.img

    - name: Zip Image
      run: |
        zip ${{ steps.copy.outputs.image }}.zip ${{ steps.copy.outputs.image }}.img
        echo "File size of ${{ steps.copy.outputs.image }}.zip"
        stat --printf="%s" ${{ steps.copy.outputs.image }}.zip

    - name: Upload artifacts
      if: ${{ !inputs.create_release }}
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          ${{ steps.copy.outputs.image }}.zip
          ${{ steps.copy.outputs.image }}-build.log
        retention-days: 7

    - name: Show release notes
      run: |
        echo "Release Notes:"
        echo "=============="
        echo "The MonsterPi image for running FDM Monster on Raspberry Pi."
        echo ""
        echo "**Build Date:** ${{ steps.copy.outputs.build_date }}"
        echo "**FDM Monster Version:** ${{ steps.copy.outputs.fdm_monster_version }}"
        echo "**Image Version:** ${{ steps.copy.outputs.tag }}"
        echo ""
        echo "${{ inputs.release_notes_suffix }}"

    - name: Generate release notes
      if: inputs.create_release
      id: release_notes
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        TAG="${{ inputs.github_release_tag != '' && inputs.github_release_tag || steps.copy.outputs.tag }}"

        # Generate automatic notes
        AUTO_NOTES=$(gh api repos/${{ github.repository }}/releases/generate-notes \
          -f tag_name="$TAG" \
          -f target_commitish="${{ github.sha }}" \
          --jq '.body' || echo "")

        # Create custom template
        cat > release-notes.md << 'EOF'
        The MonsterPi image for running FDM Monster on Raspberry Pi.

        **Build Date:** ${{ steps.copy.outputs.build_date }}
        **FDM Monster Version:** ${{ steps.copy.outputs.fdm_monster_version }}
        **Image Version:** ${{ steps.copy.outputs.tag }}

        ${{ inputs.release_notes_suffix }}

        ---

        EOF

        # Append auto-generated notes if available
        if [ -n "$AUTO_NOTES" ]; then
          echo "$AUTO_NOTES" >> release-notes.md
        fi

        echo "release_tag=$TAG" >> $GITHUB_OUTPUT

    - name: Create release
      if: inputs.create_release
      id: create_release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        PRERELEASE_FLAG=""
        TAG="${{ steps.release_notes.outputs.release_tag }}"

        # Check if this should be a prerelease
        if [[ "$TAG" == *"rc"* ]] || [[ "$TAG" == *"unstable"* ]] || [[ "$TAG" == *"nightly"* ]]; then
          PRERELEASE_FLAG="--prerelease"
        fi

        # Create release
        gh release create "$TAG" \
          --title "MonsterPi $TAG" \
          --notes-file release-notes.md \
          $PRERELEASE_FLAG

    - name: Upload release assets
      if: inputs.create_release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        TAG="${{ steps.release_notes.outputs.release_tag }}"

        gh release upload "$TAG" \
          "${{ steps.copy.outputs.image }}.zip#${{ steps.copy.outputs.image }}.zip" \
          "${{ steps.copy.outputs.image }}-build.log#${{ steps.copy.outputs.image }}-build.log"

    - name: Generate and upload Raspberry Pi Imager JSON
      if: inputs.create_release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        TAG="${{ steps.release_notes.outputs.release_tag }}"

        # Construct the download URL for the zip file
        ZIP_URL="https://github.com/${{ github.repository }}/releases/download/$TAG/${{ steps.copy.outputs.image }}.zip"

        # Generate the RPI Imager JSON
        source repository/src/config
        python3 CustomPiOS/src/custompios_core/make_rpi-imager-snipplet.py \
          --rpi_imager_url "$ZIP_URL" \
          -- default

        # Show the generated JSON
        echo "Raspberry Pi Imager JSON:"
        echo "========================="
        cat repository/src/workspace/your-distro-rpi-imager-default.json

        # Upload to release
        gh release upload "$TAG" \
          "repository/src/workspace/your-distro-rpi-imager-default.json#your-distro-rpi-imager.json"
