---

name: Build Image (Reusable)
on:
  workflow_call:
    inputs:
      version_strategy:
        description: 'Version strategy: nightly or release'
        required: true
        type: string
      create_release:
        description: 'Create GitHub release'
        required: false
        type: boolean
        default: false
      always_zip:
        description: 'Always zip the image'
        required: false
        type: boolean
        default: false
      fetch_depth:
        description: 'Git fetch depth'
        required: false
        type: number
        default: 1
    outputs:
      tag:
        description: 'Image tag'
        value: ${{ jobs.build.outputs.tag }}
      image:
        description: 'Image name'
        value: ${{ jobs.build.outputs.image }}

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    outputs:
      tag: ${{ steps.copy.outputs.tag }}
      image: ${{ steps.copy.outputs.image }}
    steps:
    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install coreutils p7zip-full qemu-user-static python3-git

    - name: Checkout CustomPiOS
      uses: actions/checkout@v6.0.1
      with:
        repository: 'guysoft/CustomPiOS'
        path: CustomPiOS
        ref: "79b77a4c1a34ef551ab09e9bd84710d048b65e55"

    - name: Checkout Project Repository
      uses: actions/checkout@v6.0.1
      with:
        path: repository
        submodules: true
        fetch-depth: ${{ inputs.fetch_depth }}

    - name: Install GitVersion
      if: inputs.version_strategy == 'release'
      uses: gittools/actions/gitversion/setup@v4.2.0
      with:
        versionSpec: '6.x'

    - name: Use GitVersion
      if: inputs.version_strategy == 'release'
      uses: gittools/actions/gitversion/execute@v4.2.0
      id: gitversion
      with:
        targetPath: repository

    - name: Download RaspberryPiOS Image
      run: |
        cd repository/src/image-raspberrypiarm64
        wget -c --trust-server-names 'https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2025-12-04/2025-12-04-raspios-trixie-arm64-lite.img.xz'

    - name: Update CustomPiOS Paths
      run: |
        cd repository/src
        ../../CustomPiOS/src/update-custompios-paths

    - name: Set nightly image version
      if: inputs.version_strategy == 'nightly'
      run: |
        source repository/src/config
        NOW=$(date +"%Y-%m-%d")
        echo "DIST_VERSION=$DIST_VERSION-$NOW-nightly" > repository/src/config.local

    - name: Set release image version
      if: inputs.version_strategy == 'release'
      run: |
        source repository/src/config
        echo "DIST_VERSION=${{ steps.gitversion.outputs.majorMinorPatch }}" > repository/src/config.local

    - name: Build Image
      run: |
        sudo modprobe loop
        cd repository/src
        sudo bash -x ./build_dist

    - name: Copy output
      id: copy
      run: |
        source repository/src/config
        if [ "${{ inputs.version_strategy }}" == "nightly" ]; then
          NOW=$(date +"%Y-%m-%d")
          TAG=${DIST_VERSION}-${NOW}-nightly
        else
          TAG=${DIST_VERSION}
        fi
        IMAGE=monsterpi-$TAG

        cp repository/src/workspace/*.img $IMAGE.img

        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "image=$IMAGE" >> $GITHUB_OUTPUT

    - name: Show size and tag
      run: |
        echo "Tag ${{steps.copy.outputs.tag}}"
        echo "File size of ${{ steps.copy.outputs.image }}.img"
        stat --printf="%s" ${{ steps.copy.outputs.image }}.img

    - name: Zip Image
      if: inputs.always_zip
      run: |
        zip ${{ steps.copy.outputs.image }}.zip ${{ steps.copy.outputs.image }}.img
        echo "File size of ${{ steps.copy.outputs.image }}.zip"
        stat --printf="%s" ${{ steps.copy.outputs.image }}.zip

    - name: Generate Raspberry Pi Imager JSON
      if: inputs.create_release
      run: |
        source repository/src/config
        python3 CustomPiOS/src/custompios_core/make_rpi-imager-snipplet.py \
          --rpi_imager_url "${{ steps.upload_zip.outputs.browser_download_url }}" \
          -- default

    - name: Create release
      if: inputs.create_release
      uses: actions/create-release@v1
      id: create_release
      with:
        draft: false
        prerelease: ${{ contains(steps.copy.outputs.tag, 'rc') || contains(steps.copy.outputs.tag, 'unstable') }}
        tag_name: ${{ steps.copy.outputs.tag }}
        release_name: MonsterPi ${{ steps.copy.outputs.image }}
        body: "The MonsterPi image for running FDM Monster on Raspberry Pi. Release notes will be added manually."
      env:
        GITHUB_TOKEN: ${{ github.token }}

    - name: Upload server bundle zip
      if: inputs.create_release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ steps.copy.outputs.image }}.zip
        asset_name: ${{ steps.copy.outputs.image }}.zip
        asset_content_type: application/zip

    - name: Upload Raspberry Pi Imager JSON
      if: inputs.create_release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: repository/src/workspace/your-distro-rpi-imager-default.json
        asset_name: your-distro-rpi-imager.json
        asset_content_type: application/json
