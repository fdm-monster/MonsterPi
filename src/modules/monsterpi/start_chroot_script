#!/usr/bin/env bash
# start_chroot_script
# This installs FDM Monster using the official fdm-monster-scripts installer and HAProxy
# Written by David Zwart
# GPL V3
########

# Source error handling, leave this in place
set -x
set -e

# Variables
fdmm_npm_package="@fdm-monster/server"
fdmm_version="${MONSTERPI_FDMMONSTER_VERSION}"
fdmm_nodejs_version="${MONSTERPI_NODEJS_VERSION:-24.12.0}"
fdmm_server_port="4000"
installer_url="https://raw.githubusercontent.com/fdm-monster/fdm-monster-scripts/main/install/linux/install.sh"
installer_path="/tmp/fdm-monster-install.sh"

# Setup
source /common.sh
install_cleanup_trap

unpack /filesystem/home/pi /home/"${BASE_USER}" "${BASE_USER}"
unpack /filesystem/home/root /root root
unpack /filesystem/boot /boot

apt update

# Optimize apt packages by removing unused ones
remove_extra=$(remove_if_installed scratch squeak-plugins-scratch squeak-vm wolfram-engine python-minecraftpi minecraft-pi sonic-pi oracle-java8-jdk bluej libreoffice-common libreoffice-core freepats greenfoot nodered)
echo "removing:" "$remove_extra"
apt-get remove -y --purge  "$remove_extra"
apt-get autoremove -y
if [ "${BASE_DISTRO}" == "ubuntu" ]; then
    apt-get -y install jq git screen libffi-dev libssl-dev libatlas3-base libraspberrypi-bin rpi.gpio-common ca-certificates curl
else
    apt-get -y install jq git screen libffi-dev libssl-dev libatlas3-base ca-certificates curl
fi

echo "Downloading FDM Monster installer from GitHub..."
curl -fsSL "${installer_url}" -o "${installer_path}"

# Install FDM Monster using local installer script (provides nice CLI)
# Run as pi user so all caches (.yarn, .cache) are created in correct location
# Script uses sudo internally when needed (service file creation)
echo "Installing FDM Monster ${fdmm_version} with local installer..."

sudo -u "${BASE_USER}" \
    FDMM_NODE_VERSION="${fdmm_nodejs_version}" \
    FDMM_NPM_PACKAGE="${fdmm_npm_package}" \
    FDMM_NPM_PACKAGE_VERSION="${fdmm_version}" \
    FDMM_HOME="/home/${BASE_USER}" \
    FDMM_INSTALL_DIR="/home/${BASE_USER}/.fdm-monster" \
    FDMM_DATA_DIR="/home/${BASE_USER}/.fdm-monster-data" \
    FDMM_SERVER_PORT="${fdmm_server_port}" \
    bash "${installer_path}" install

# Clean up the installer script
rm -f "${installer_path}"    

# Setup HAProxy and SSL
if [ "$MONSTERPI_INCLUDE_HAPROXY" == "yes" ]
then
    echo "Setting up HAProxy for HTTP and HTTPS..."
    apt -y install ssl-cert haproxy
    rm /etc/ssl/private/ssl-cert-snakeoil.key /etc/ssl/certs/ssl-cert-snakeoil.pem
    chmod +x /root/bin/gencert
fi

# Configure Boot Messages
# Note, this code is also in /filesystem/home/pi/scripts/
sed -i 's@exit 0@@' /etc/rc.local
cat <<'EOT' >> /etc/rc.local

echo
echo "------------------------------------------------------------"
echo
echo "You may now open a web browser on your local network and "
echo "navigate to any of the following addresses to access "
echo "FDM Monser:"
echo
for name in $_NAME;
do
    echo " http://$name.local"
done

for ip in $(hostname -I);
do
    echo "    http://$ip"
done

echo
echo "https is also available, with a self-signed certificate."
echo
echo "------------------------------------------------------------"
echo
EOT
echo 'exit 0' >> /etc/rc.local

# Configure User Environment
# Inject FDM Monster installation directory into welcome script
sed -i "s|__FDMM_INSTALL_DIR__|${FDMM_INSTALL_DIR}|g" /home/"${BASE_USER}"/scripts/welcome

# Add welcome message to user's bashrc
echo "source /home/${BASE_USER}/scripts/welcome" >> /home/"${BASE_USER}"/.bashrc

# Finalize System Configuration
# Unpack root at the end, so files are modified before
unpack /filesystem/root /

# Enable certificate generation service if HAProxy is enabled
if [ "$MONSTERPI_INCLUDE_HAPROXY" == "yes" ]
then
  systemctl_if_exists enable gencert.service
else
  # Remove the configs for system services we don't need
  rm -f /etc/systemd/system/gencert.service
fi

# Cleanup
apt-get clean
apt-get autoremove -y
