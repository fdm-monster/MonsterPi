#!/usr/bin/env bash
# start_chroot_script
# This installs FDM Monster using the official fdm-monster-scripts installer and HAProxy
# Written by David Zwart
# GPL V3
########

# Source error handling, leave this in place
set -x
set -e

# Variables
fdmm_npm_package="@fdm-monster/server"
fdmm_version="${MONSTERPI_FDMMONSTER_VERSION}"
fdmm_nodejs_version="${MONSTERPI_NODEJS_VERSION:-24.12.0}"
fdmm_server_port="4000"
fdmm_home="/home/${BASE_USER}"
fdmm_install_dir="${fdmm_home}/.fdm-monster"
fdmm_data_dir="${fdmm_home}/.fdm-monster-data"
installer_url="https://raw.githubusercontent.com/fdm-monster/fdm-monster-scripts/main/install/linux/install.sh"
installer_path="/tmp/fdm-monster-install.sh"

# Setup
source /common.sh
install_cleanup_trap

unpack /filesystem/home/pi /home/"${BASE_USER}" "${BASE_USER}"
unpack /filesystem/home/root /root root
unpack /filesystem/boot /boot

apt update

# Optimize apt packages by removing unused ones
remove_extra=$(remove_if_installed scratch squeak-plugins-scratch squeak-vm wolfram-engine python-minecraftpi minecraft-pi sonic-pi oracle-java8-jdk bluej libreoffice-common libreoffice-core freepats greenfoot nodered)
echo "removing:" "$remove_extra"
apt-get remove -y --purge  "$remove_extra"
apt-get autoremove -y
if [ "${BASE_DISTRO}" == "ubuntu" ]; then
    apt-get -y install jq git screen libffi-dev libssl-dev libatlas3-base libraspberrypi-bin rpi.gpio-common ca-certificates curl
else
    apt-get -y install jq git screen libffi-dev libssl-dev libatlas3-base ca-certificates curl
fi

echo "Downloading FDM Monster installer from GitHub..."
curl -fsSL "${installer_url}" -o "${installer_path}"

# Set up FDM Monster installation environment
export FDMM_NODE_VERSION="${fdmm_nodejs_version}"
export FDMM_NPM_PACKAGE="${fdmm_npm_package}"
export FDMM_NPM_PACKAGE_VERSION="${fdmm_version}"
export FDMM_HOME="${fdmm_home}"
export FDMM_INSTALL_DIR="${fdmm_install_dir}"
export FDMM_DATA_DIR="${fdmm_data_dir}"
export FDMM_SERVER_PORT="${fdmm_server_port}"
export FDMM_SERVICE_USER="${BASE_USER}"

# Install FDM Monster using local installer script (provides nice CLI)
# Split into two phases for chroot environment:
# 1. User-level: nodejs, yarn, fdm-monster package, CLI wrapper (run as pi user)
# 2. Root-level: systemd service setup (run with appropriate privileges)

echo "Installing FDM Monster ${fdmm_version} - User-level components..."
sudo -u "${BASE_USER}" bash "${installer_path}" install-user

echo "Installing FDM Monster ${fdmm_version} - Root-level components..."
bash "${installer_path}" install-root

# Verify that the systemd service was created with the correct user
echo "Verifying systemd service configuration..."
if [ ! -f /etc/systemd/system/fdm-monster.service ]; then
    echo "ERROR: fdm-monster.service was not created by install-root"
    exit 1
fi

# Check that User is set to BASE_USER and not root
if grep -q "^User=root$" /etc/systemd/system/fdm-monster.service; then
    echo "ERROR: fdm-monster.service is configured to run as root instead of ${BASE_USER}"
    cat /etc/systemd/system/fdm-monster.service
    exit 1
fi

if ! grep -q "^User=${BASE_USER}$" /etc/systemd/system/fdm-monster.service; then
    echo "ERROR: fdm-monster.service does not have User=${BASE_USER} configured"
    cat /etc/systemd/system/fdm-monster.service
    exit 1
fi

echo "Service configuration verified: User=${BASE_USER}"

# Clean up the installer script
rm -f "${installer_path}"

# Setup HAProxy and SSL
if [ "$MONSTERPI_INCLUDE_HAPROXY" == "yes" ]
then
    echo "Setting up HAProxy for HTTP and HTTPS..."
    apt -y install ssl-cert haproxy
    rm /etc/ssl/private/ssl-cert-snakeoil.key /etc/ssl/certs/ssl-cert-snakeoil.pem
    chmod +x /root/bin/gencert
fi

# Configure Boot Messages
# Note, this code is also in /filesystem/home/pi/scripts/
sed -i 's@exit 0@@' /etc/rc.local
cat <<'EOT' >> /etc/rc.local

echo
echo "------------------------------------------------------------"
echo
echo "You may now open a web browser on your local network and "
echo "navigate to any of the following addresses to access "
echo "FDM Monser:"
echo
for name in $_NAME;
do
    echo " http://$name.local"
done

for ip in $(hostname -I);
do
    echo "    http://$ip"
done

echo
echo "https is also available, with a self-signed certificate."
echo
echo "------------------------------------------------------------"
echo
EOT
echo 'exit 0' >> /etc/rc.local

# Configure User Environment
# Inject FDM Monster installation directory into welcome script
sed -i "s|__FDMM_INSTALL_DIR__|${fdmm_install_dir}|g" /home/"${BASE_USER}"/scripts/welcome

# Add welcome message to user's bashrc
echo "source /home/${BASE_USER}/scripts/welcome" >> /home/"${BASE_USER}"/.bashrc

# Finalize System Configuration
# Unpack root at the end, so files are modified before
unpack /filesystem/root /

# Enable certificate generation service if HAProxy is enabled
if [ "$MONSTERPI_INCLUDE_HAPROXY" == "yes" ]
then
  systemctl_if_exists enable gencert.service
else
  # Remove the configs for system services we don't need
  rm -f /etc/systemd/system/gencert.service
fi

# Cleanup
apt-get clean
apt-get autoremove -y
