#!/usr/bin/env bash
# start_chroot_script
# This installs MongoDB as well as FDM Monster and HAProxy
# Written by David Zwart
# GPL V3
########

# Source error handling, leave this in place
set -x
set -e

org=fdm-monster
repo=fdm-monster
repo_url="https://github.com/${org}/${repo}"

source /common.sh
install_cleanup_trap

unpack /filesystem/home/pi /home/"${BASE_USER}" "${BASE_USER}"
unpack /filesystem/home/root /root root
unpack /filesystem/boot /boot

apt update

# Optimize apt packages by removing unused ones
remove_extra=$(remove_if_installed scratch squeak-plugins-scratch squeak-vm wolfram-engine python-minecraftpi minecraft-pi sonic-pi oracle-java8-jdk bluej libreoffice-common libreoffice-core freepats greenfoot nodered)
echo "removing:" "$remove_extra"
apt-get remove -y --purge  "$remove_extra"
apt-get autoremove -y
if [ "${BASE_DISTRO}" == "ubuntu" ]; then
    apt-get -y install jq git screen libffi-dev libssl-dev libatlas3-base libraspberrypi-bin rpi.gpio-common ca-certificates
else
    apt-get -y install jq git screen libffi-dev libssl-dev libatlas3-base ca-certificates
fi

# Install GPG
apt install -y gnupg

# Add MongoDB as trusted source list
wget -qO - https://www.mongodb.org/static/pgp/server-"$MONSTERPI_MONGODB_VERSION".asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/`cat /etc/os-release | grep "^ID=" | cut -d "=" -f2` `cat /etc/os-release | grep "^VERSION_CODENAME=" | cut -d "=" -f2`/mongodb-org/$MONSTERPI_MONGODB_VERSION multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-$MONSTERPI_MONGODB_VERSION.list
apt update

# Install MongoDB
sudo apt install -y mongodb-org=4.4.15 mongodb-org-server=4.4.15 mongodb-org-shell=4.4.15 mongodb-org-mongos=4.4.15 mongodb-org-tools=4.4.15
systemctl enable mongod
systemctl start mongod

# Install NodeJS based on MONSTERPI_NODEJS_VERSION
curl -sL https://deb.nodesource.com/setup_$MONSTERPI_NODEJS_VERSION | bash -
apt update
apt install -y nodejs

# Update NPM and install yarn globally
npm install -g npm
npm install -g yarn

pushd /home/"${BASE_USER}"
    # Fetch latest release of FDM Monster
    tag=$(git ls-remote --tags $repo_url | awk -F"/" '{print $NF}' | grep -E "^[[:digit:]]+\.[[:digit:]]+\.[[:digit:]]+$" | sort -V | tail -1)

    # Install FDM Monster
    sudo -u "${BASE_USER}" git clone https://github.com/fdm-monster/fdm-monster.git /home/"${BASE_USER}"/fdm-monster --branch "${tag}"

    # Update the packages (this is really slow on QEMU!)
    cd /home/"${BASE_USER}"/fdm-monster/server
    yarn install --production --frozen-lockfile --network-timeout 1000000000

    # Prepare the systemd service
    cd /home/"${BASE_USER}"/fdm-monster-daemon
    npm i node-linux
    npm i

    # Enable the systemd service at boot
    systemctl enable fdmmonster

    # Setup haproxy for http and https
    if [ "$MONSTERPI_INCLUDE_HAPROXY" == "yes" ]
    then
        echo "--- Installing haproxy"
        apt -y install ssl-cert haproxy
        rm /etc/ssl/private/ssl-cert-snakeoil.key /etc/ssl/certs/ssl-cert-snakeoil.pem
    fi
popd

# Unpack root at the end, so files are modified before
unpack /filesystem/root /
